<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="meta-title">Loading...</title>
  <meta id="meta-description" name="description" content="">
</head>
<body>

<a href="/blog.html">‚Üê Back to Blog</a>

<h1 id="title"></h1>
<p id="date"></p>
<div id="content"></div>

<script>
const SPACE_ID = "09muo917z9ra";
const ACCESS_TOKEN = "Z2-ybwP2VOWRp1wNWpxaaAl0P8sekgACZD-QXYDFrdw";

const params = new URLSearchParams(window.location.search);
const slug = params.get("slug");

async function loadPost() {
  if (!slug) {
    document.getElementById("content").innerHTML = "<p>No post selected. Please provide a slug in the URL.</p>";
    return;
  }

  try {
    const res = await fetch(
      `https://cdn.contentful.com/spaces/${SPACE_ID}/environments/master/entries?access_token=${ACCESS_TOKEN}&content_type=blogPost&fields.slug[in]=${slug}&include=1`
    );

    const data = await res.json();

    if (!data.items.length) {
      document.getElementById("content").innerHTML = "<p>Post not found. Check the slug in the URL.</p>";
      return;
    }

    const item = data.items[0].fields;

    // Title & Date
    document.getElementById("title").innerText = item.title || "Untitled Post";
    const pubDate = item.publishedDate || new Date().toISOString();
    document.getElementById("date").innerText = new Date(pubDate).toLocaleDateString();
    document.title = item.title || "Blog Post";

    // --- Detect content field ---
    // Common names: content, body, postContent
    let contentField = item.content || item.body || item.postContent || null;

    if (!contentField) {
      document.getElementById("content").innerHTML = "<p>This post has no content field.</p>";
      return;
    }

    // Render content
    // If it's Rich Text JSON, convert to HTML safely
    if (typeof contentField === "object" && contentField.nodeType) {
      // Minimal fallback: show JSON as string (replace with Rich Text renderer if needed)
      document.getElementById("content").innerHTML = "<pre>" + JSON.stringify(contentField, null, 2) + "</pre>";
    } else {
      // Plain text or HTML
      document.getElementById("content").innerHTML = contentField;
    }

    // --- BlogPosting Schema for SEO ---
    const plainText = contentField && typeof contentField === "string"
      ? contentField.replace(/<[^>]+>/g, '').substring(0, 160)
      : item.title.substring(0, 160);

    const schema = {
      "@context": "https://schema.org",
      "@type": "BlogPosting",
      "headline": item.title || "Blog Post",
      "description": plainText,
      "datePublished": pubDate,
      "dateModified": pubDate,
      "mainEntityOfPage": window.location.href,
      "author": { "@type": "Organization", "name": "Calming Currents Beauty Spa" },
      "publisher": {
        "@type": "Organization",
        "name": "Calming Currents Beauty Spa",
        "logo": { "@type": "ImageObject", "url": "https://calmingcurrentsbeautyspa.com/images/logo.png" }
      }
    };

    // Add featured image if exists
    if(item.featuredImage?.fields?.file?.url){
      schema.image = "https:" + item.featuredImage.fields.file.url;
    }

    const script = document.createElement("script");
    script.type = "application/ld+json";
    script.textContent = JSON.stringify(schema);
    document.head.appendChild(script);

  } catch (err) {
    console.error("Error loading post:", err);
    document.getElementById("content").innerHTML = "<p>Error loading post. Check console for details.</p>";
  }
}

loadPost();
</script>

</body>
</html>
